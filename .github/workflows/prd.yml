name: Standard

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Escolha qual servi√ßo rodar: web, api ou ambos'
        required: true
        default: 'both'
        type: choice
        options:
          - web
          - api
          - both

jobs:
  deploy-api-dev:
    if: inputs.target == 'api' || inputs.target == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Backend Dependencies
        working-directory: ./packages/api
        run: npm install

      - name: Run Backend Tests
        working-directory: ./packages/api
        run: npm test

      - name: Deploy Backend to DEV
        working-directory: ./packages/api
        run: echo "Deploying api to DEV environment"

  deploy-web-dev:
    if: inputs.target == 'web' || inputs.target == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Frontend Dependencies
        working-directory: ./packages/web
        run: npm install

      - name: Build Frontend
        working-directory: ./packages/web
        run: npm run build

      - name: Deploy Frontend to Netlify (DEV)
        working-directory: ./packages/web
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: npx netlify-cli deploy --dir=build --site=$NETLIFY_DEV_SITE_ID

  approve-prd:
    needs: [deploy-backend-dev, deploy-frontend-dev]
    runs-on: ubuntu-latest
    if: inputs.target == 'api' || inputs.target == 'web' || inputs.target == 'both'
    steps:
      - name: Await Approval for PRD
        uses: actions/manual-approval-action@v1
        with:
          prompt: "Approve PRD deployment?"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-api-prd:
    if: inputs.target == 'api' || inputs.target == 'both'
    runs-on: ubuntu-latest
    needs: [approve-prd]
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Backend Dependencies
        working-directory: ./packages/api
        run: npm install

      - name: Run Backend Tests
        working-directory: ./packages/api
        run: npm test

      - name: Deploy Backend to PRD
        working-directory: ./packages/api
        run: echo "Deploying api to PRD environment"

  deploy-web-prd:
    if: inputs.target == 'web' || inputs.target == 'both'
    runs-on: ubuntu-latest
    needs: [approve-prd]
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Frontend Dependencies
        working-directory: ./packages/web
        run: npm install

      - name: Build Frontend
        working-directory: ./packages/web
        run: npm run build

      - name: Deploy Frontend to Netlify (PRD)
        working-directory: ./packages/web
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: npx netlify-cli deploy --dir=build --site=$NETLIFY_PRD_SITE_ID
